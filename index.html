<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gi√°m s√°t ƒëi·ªán 3 pha</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js">
  /* ================= MQTT CONFIG ================= */
  // S·ª≠ d·ª•ng MQTT over WebSocket
  // V√≠ d·ª• d√πng HiveMQ public broker
  const mqttBroker = 'wss://broker.hivemq.com:8884/mqtt';
  const mqttOptions = {
    clean: true,
    connectTimeout: 4000,
    clientId: 'web_hcmute_' + Math.random().toString(16).substr(2, 8)
  };

  // Kh·ªüi t·∫°o MQTT client
  const client = mqtt.connect(mqttBroker, mqttOptions);

  client.on('connect', () => {
    console.log('MQTT connected');
    client.subscribe('hcmute/energy/#');
  });

  client.on('error', (err) => {
    console.error('MQTT error', err);
  });

  // Nh·∫≠n d·ªØ li·ªáu t·ª´ HMI qua MQTT
  client.on('message', (topic, message) => {
    try {
      const data = JSON.parse(message.toString());

      /* --------- ƒêI·ªÜN √ÅP --------- */
      if (topic === 'hcmute/energy/voltage') {
        // data: { p12, p23, p31, p1n, p2n, p3n }
        document.querySelector('#voltage td:nth-child(1)').innerText = data.p12 + ' V';
        document.querySelector('#voltage td:nth-child(2)').innerText = data.p23 + ' V';
        document.querySelector('#voltage td:nth-child(3)').innerText = data.p31 + ' V';
        document.querySelectorAll('#voltage tr')[3].children[0].innerText = data.p1n + ' V';
        document.querySelectorAll('#voltage tr')[3].children[1].innerText = data.p2n + ' V';
        document.querySelectorAll('#voltage tr')[3].children[2].innerText = data.p3n + ' V';
      }

      /* --------- D√íNG ƒêI·ªÜN --------- */
      if (topic === 'hcmute/energy/current') {
        // data: { i1, i2, i3 }
        document.querySelector('#current td:nth-child(1)').innerText = data.i1 + ' A';
        document.querySelector('#current td:nth-child(2)').innerText = data.i2 + ' A';
        document.querySelector('#current td:nth-child(3)').innerText = data.i3 + ' A';
      }

      /* --------- T·∫¶N S·ªê --------- */
      if (topic === 'hcmute/energy/frequency') {
        // data: { f }
        document.querySelector('#freq h1').innerText = data.f + ' Hz';
      }

      /* --------- NƒÇNG L∆Ø·ª¢NG --------- */
      if (topic === 'hcmute/energy/energy') {
        // data: { kwh, kvah }
        document.querySelector('#power td:nth-child(1)').innerText = data.kwh + ' kWh';
        document.querySelector('#power td:nth-child(2)').innerText = data.kvah + ' kVAh';
      }

    } catch (e) {
      console.error('Parse MQTT message error', e);
    }
  });
</script>
  <style>
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{margin:0;background:#0f1220;color:#fff}
    .hidden{display:none}
    .container{padding:20px}
    h1,h2{text-align:center}
    button{padding:14px;border:none;border-radius:10px;font-size:16px;cursor:pointer}
    .btn{width:100%;color:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px}
    .card{padding:20px;border-radius:15px;text-align:center;font-weight:bold}
    .red{background:#e53935}
    .green{background:#43a047}
    .blue{background:#1e88e5}
    .orange{background:#fb8c00}
    .gray{background:#5f6a7d}
    .back{margin-top:15px;background:#374151}
    .login{max-width:350px;margin:80px auto}
    input{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none}
    canvas{background:#fff;border-radius:10px;padding:10px}
    table{width:100%;border-collapse:collapse;margin-bottom:15px}
    td,th{border:1px solid #555;padding:6px;text-align:center}
  </style>
</head>
<body>
<header style="display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:#020617;border-bottom:2px solid #0ea5e9">
  <img src="hcmute-logo.png" alt="HCMUTE" style="height:55px" />
  <div style="text-align:center">
    <div style="font-weight:bold;font-size:16px">Tr∆∞·ªùng ƒê·∫°i h·ªçc S∆∞ Ph·∫°m K·ªπ Thu·∫≠t TP.HCM</div>
    <div style="font-size:14px;color:#38bdf8">Khoa C∆° Kh√≠ Ch·∫ø T·∫°o M√°y</div>
  </div>
  <img src="logo_khoa.jpg" alt="Khoa C∆° Kh√≠ Ch·∫ø T·∫°o M√°y" style="height:55px" />
</header>

<!-- LOGIN -->
<div id="login" class="login">
  <h2>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h2>
  <input placeholder="T√™n ƒëƒÉng nh·∫≠p" type="text" />
  <input type="password" placeholder="M·∫≠t kh·∫©u" />
  <button class="btn green" onclick="login()">ƒêƒÉng nh·∫≠p</button>
</div>

<!-- MENU -->
<div id="menu" class="container hidden">
  <h1>MENU GI√ÅM S√ÅT 3 PHA</h1>
  <div class="grid">
    <button class="card red" onclick="show('voltage')">‚ö° ƒêi·ªán √°p (V)</button>
    <button class="card green" onclick="show('current')">‚àöx D√≤ng ƒëi·ªán (I)</button>
    <button class="card blue" onclick="show('freq')">„Ä∞ T·∫ßn s·ªë (F)</button>
    <button class="card orange" onclick="show('power')">‚èª NƒÉng l∆∞·ª£ng ti√™u th·ª•</button>
    <button class="card gray" onclick="exportExcel()">üìÑ Export Data</button>
    <button class="card gray" onclick="show('setting')">‚öô C√†i ƒë·∫∑t</button>
  </div>
  <button class="btn back" onclick="show('login')">Tho√°t</button>
</div>

<!-- ƒêI·ªÜN √ÅP -->
<div id="voltage" class="container hidden">
  <h2>ƒêi·ªán √°p (V)</h2>
  <table>
    <tr><th>Phase 1-2 (V)</th><th>Phase 2-3 (V)</th><th>Phase 3-1 (V)</th></tr>
    <tr><td>380 V</td><td>381 V</td><td>379 V</td></tr>
    <tr><th>Phase 1-N (V)</th><th>Phase 2-N (V)</th><th>Phase 3-N (V)</th></tr>
    <tr><td>220 V</td><td>221 V</td><td>219 V</td></tr>
  </table>
  <canvas id="vChart"></canvas>
  <button class="btn back" onclick="show('menu')">Quay l·∫°i</button>
</div>

<!-- D√íNG ƒêI·ªÜN -->
<div id="current" class="container hidden">
  <h2>D√≤ng ƒëi·ªán (A)</h2>
  <table>
    <tr><th>I1 (A)</th><th>I2 (A)</th><th>I3 (A)</th></tr>
    <tr><td>10 A</td><td>11 A</td><td>9 A</td></tr>
  </table>
  <canvas id="iChart"></canvas>
  <button class="btn back" onclick="show('menu')">Quay l·∫°i</button>
</div>

<!-- T·∫¶N S·ªê -->
<div id="freq" class="container hidden">
  <h2>T·∫ßn s·ªë (Hz)</h2>
  <h1>50 Hz</h1>
  <canvas id="fChart"></canvas>
  <button class="btn back" onclick="show('menu')">Quay l·∫°i</button>
</div>

<!-- C√îNG SU·∫§T -->
<div id="power" class="container hidden">
  <h2>NƒÉng l∆∞·ª£ng ti√™u th·ª•</h2>
  <table>
    <tr><th>kWh</th><th>kVAh</th></tr>
    <tr><td>125.4</td><td>138.2</td></tr>
  </table>
  <canvas id="pChart"></canvas>
  <button class="btn back" onclick="show('menu')">Quay l·∫°i</button>
</div>

<!-- C√ÄI ƒê·∫∂T -->
<div id="setting" class="container hidden">
  <h2>C√†i ƒë·∫∑t h·ªá th·ªëng</h2>

  <h3>1. C·∫•u h√¨nh k·∫øt n·ªëi MQTT</h3>
  <table>
    <tr><td>Broker</td><td><input placeholder="mqtt://broker.hivemq.com"></td></tr>
    <tr><td>Port</td><td><input placeholder="1883"></td></tr>
    <tr><td>Topic</td><td><input placeholder="hcmute/energy"></td></tr>
  </table>

  <h3>2. Chu k·ª≥ l·∫•y m·∫´u</h3>
  <table>
    <tr><td>Th·ªùi gian c·∫≠p nh·∫≠t (ms)</td><td><input placeholder="1000"></td></tr>
  </table>

  <h3>3. Ng∆∞·ª°ng c·∫£nh b√°o</h3>
  <table>
    <tr><td>Qu√° √°p (V)</td><td><input placeholder="250"></td></tr>
    <tr><td>Qu√° d√≤ng (A)</td><td><input placeholder="20"></td></tr>
  </table>

  <h3>4. Giao di·ªán</h3>
  <table>
    <tr><td>Ch·∫ø ƒë·ªô hi·ªÉn th·ªã</td><td>
      <select>
        <option>Dark mode</option>
        <option>Light mode</option>
      </select>
    </td></tr>
  </table>

  <p style="color:#94a3b8">(C√°c ch·ª©c nƒÉng tr√™n mang t√≠nh m√¥ ph·ªèng, c√≥ th·ªÉ m·ªü r·ªông trong nghi√™n c·ª©u ti·∫øp theo)</p>

  <button class="btn back" onclick="show('menu')">Quay l·∫°i</button>
</div>

<script>
  function login(){
    const user = document.querySelector('#login input[type=text], #login input:not([type])').value;
    const pass = document.querySelector('#login input[type=password]').value;
    if(user === 'hcmute' && pass === '1234'){
      show('menu');
    } else {
      alert('Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u');
    }
  }

  function show(id){
    document.querySelectorAll('body > div').forEach(d=>d.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  function chart(id,label,data){
    new Chart(document.getElementById(id),{
      type:'line',
      data:{labels:['1','2','3','4','5'],datasets:label.map((l,i)=>({label:l,data:data[i],borderWidth:2}))}
    })
  }

  chart('vChart',['U1','U2','U3'],[[220,221,219,220,222],[221,222,220,221,223],[219,218,220,219,221]])
  chart('iChart',['I1','I2','I3'],[[10,11,10,9,10],[11,12,11,10,11],[9,8,9,9,10]])
  chart('fChart',['F'],[[50,50.1,49.9,50,50]])
  chart('pChart',['kWh','kVAh'],[[120,121,123,124,125],[130,132,134,136,138]])

  function exportExcel(){
    alert('Xu·∫•t file Excel (demo ƒë·ªì √°n)')
  }
</script>
</body>
</html>
